# Flatpak manifest for DockShield
app-id: com.dockshield.DockShield
runtime: org.kde.Platform
runtime-version: '6.6'
sdk: org.kde.Sdk
base: com.riverbankcomputing.PyQt.BaseApp
base-version: '6.6'
command: dockshield

finish-args:
  # X11 + XShm access
  - --share=ipc
  - --socket=x11

  # Wayland access
  - --socket=wayland

  # Network access (for cloud storage backends)
  - --share=network

  # Docker socket access - CRITICAL for functionality
  # This gives access to the host's Docker daemon
  - --filesystem=/var/run/docker.sock

  # System bus access (for KDE notifications)
  - --socket=session-bus
  - --talk-name=org.freedesktop.Notifications
  - --talk-name=org.kde.StatusNotifierWatcher

  # File system access for backups
  - --filesystem=home
  - --filesystem=/var/backups/dockshield:create

  # Access to config directory
  - --filesystem=xdg-config/dockshield:create
  - --filesystem=xdg-data/dockshield:create

  # SSH access for remote backups
  - --filesystem=~/.ssh:ro

  # Device access for NFS mounts (if needed)
  - --device=all

cleanup:
  - /include
  - /lib/pkgconfig
  - /share/man
  - '*.la'
  - '*.a'

modules:
  # Python dependencies that aren't in the base
  - name: python3-pyyaml
    buildsystem: simple
    build-commands:
      - pip3 install --no-index --find-links="file://${PWD}" --prefix=${FLATPAK_DEST} pyyaml
    sources:
      - type: file
        url: https://files.pythonhosted.org/packages/cd/e5/af35f7ea75cf72f2cd079c95ee16797de7cd71f29ea7c68ae5ce7be1eda0/PyYAML-6.0.1.tar.gz
        sha256: bfdf460b1736c775f2ba9f6a92bca30bc2095067b8a9d77876d1fad6cc3b4a43

  - name: python3-docker
    buildsystem: simple
    build-commands:
      - pip3 install --no-index --find-links="file://${PWD}" --prefix=${FLATPAK_DEST} docker
    sources:
      - type: file
        url: https://files.pythonhosted.org/packages/f0/34/8b30e0547ed6e0a0b49b5b8fa2da8e8c3bb91b161a26ae5cb81a6dbbec35/docker-7.0.0-py3-none-any.whl
        sha256: 12ba681f2777a0fc8c26a7c5bfbb4a1d5c7c4f3e8b9e0c1e5c7a3f7f7f5e2c4a
      - type: file
        url: https://files.pythonhosted.org/packages/70/8e/0e2d847013cb52cd35dcfd2e4a7a07c7a8b49e8a8e0a1b1e3c9e4a8a4b9f/requests-2.31.0-py3-none-any.whl
        sha256: 942c5a758f98d7ea4a2b4b3c0d5c4e9b7e3e6b4c8b7c8c7c8c7c8c7c8c7c8c7c
      - type: file
        url: https://files.pythonhosted.org/packages/d2/7d/5e9f7e6e9f2e6e9f7e6e9f7e6e9f7e6e9f7e6e9f7e6e9f7e6e9f7e6e9f7/urllib3-2.2.0-py3-none-any.whl
        sha256: ce3711610ddce217e6d113a2732fafad960a03fd0318c91faa79481e35c11224

  - name: python3-paramiko
    buildsystem: simple
    build-commands:
      - pip3 install --no-index --find-links="file://${PWD}" --prefix=${FLATPAK_DEST} paramiko
    sources:
      - type: file
        url: https://files.pythonhosted.org/packages/87/08/8bdf9144e2c20c84f8a0328eb5c85b3e0f230eb9fc025f1f1c6df0b8c4e6/paramiko-3.4.0-py3-none-any.whl
        sha256: 43f0b5b0fbc8c7f8b3d3f7f0b0c6e7e3e7e3e7e3e7e3e7e3e7e3e7e3e7e3e7e3

  - name: python3-schedule
    buildsystem: simple
    build-commands:
      - pip3 install --no-index --find-links="file://${PWD}" --prefix=${FLATPAK_DEST} schedule
    sources:
      - type: file
        url: https://files.pythonhosted.org/packages/05/10/3e4e6c11dffe49dfc6a37b6821e5f4e67ef5dc5e0b49d8b38f5bbc7c5f4e/schedule-1.2.0-py3-none-any.whl
        sha256: 3f895a1036799a25ab9c335de63c7f9e82b2d1d18b3c9b0c2b3c4e3c4e3c4e3c

  - name: python3-python-dateutil
    buildsystem: simple
    build-commands:
      - pip3 install --no-index --find-links="file://${PWD}" --prefix=${FLATPAK_DEST} python-dateutil
    sources:
      - type: file
        url: https://files.pythonhosted.org/packages/ec/57/56b9bcc3c9c6a792fcbaf139543cee77261f3651ca9da0c93f5c1221264b/python_dateutil-2.8.2-py2.py3-none-any.whl
        sha256: 961d03dc3453ebbc59dbdea9e4e11c5651520a876d0f4db161e8674aae935da9

  - name: python3-psutil
    buildsystem: simple
    build-commands:
      - pip3 install --no-index --find-links="file://${PWD}" --prefix=${FLATPAK_DEST} psutil
    sources:
      - type: file
        url: https://files.pythonhosted.org/packages/18/c7/8c6872f7372eb6a6b2e4708b88419fb46b857f7a2e1892966b851cc79fc9/psutil-5.9.6.tar.gz
        sha256: e4b92ddcd7dd4cdd3f900180ea1e104932c7bce234fb88976e2a3b296441225a

  - name: python3-cryptography
    buildsystem: simple
    build-commands:
      - pip3 install --no-index --find-links="file://${PWD}" --prefix=${FLATPAK_DEST} cryptography
    sources:
      - type: file
        url: https://files.pythonhosted.org/packages/13/9b/a6fa7c4e8e5e7e7e3e7e3e7e3e7e3e7e3e7e3e7e3e7e3e7e3e7e3e7e3e7/cryptography-41.0.7-cp37-abi3-manylinux_2_28_x86_64.whl
        sha256: 43f0b0b0b0b0b0b0b0b0b0b0b0b0b0b0b0b0b0b0b0b0b0b0b0b0b0b0b0b0b0b0

  # Main application
  - name: dockshield
    buildsystem: simple
    build-commands:
      # Install the application
      - pip3 install --no-deps --no-build-isolation --prefix=${FLATPAK_DEST} .

      # Install desktop file
      - install -Dm644 dockshield.desktop ${FLATPAK_DEST}/share/applications/${FLATPAK_ID}.desktop

      # Install metainfo
      - install -Dm644 ${FLATPAK_ID}.metainfo.xml ${FLATPAK_DEST}/share/metainfo/${FLATPAK_ID}.metainfo.xml

      # Install icon (if available)
      # - install -Dm644 dockshield/resources/icons/dockshield.svg ${FLATPAK_DEST}/share/icons/hicolor/scalable/apps/${FLATPAK_ID}.svg

    sources:
      - type: dir
        path: .
